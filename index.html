<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Worlds</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #menu {
            margin-top: 100px;
        }
        canvas {
            border: 1px solid black;
            display: none;
        }
        #tekstiKentta {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>

<h1>Pixel Worlds</h1>
<div id="menu">
    <input type="text" id="maanNimi" placeholder="Maan nimi">
    <button onclick="liityMaa()">Create a world / Join a world</button>
</div>
<canvas id="maailma" width="800" height="600"></canvas>
<div id="tekstiKentta">
    <input type="text" id="puhekuplaTeksti" placeholder="Write something...">
</div>


<script>
var canvas = document.getElementById("maailma");
var ctx = canvas.getContext("2d");
var maailma = [];
var ilma = [];
var ukkeli = {
    x: 50,
    y: canvas.height - 50, // Alkupiste ruskeiden palikoiden päällä
    halkaisija: 30,
    nopeus: 5,
    hyppyNopeus: 10,
    hyppy: false
};
var maahanLiittynyt = false;
var writingMessage = false;
var puhekupla = {
    teksti: "",
    piilota: Date.now(),
    nakyvissa: false
};
var moveLeft = false;
var moveRight = false;

function liityMaa() {
    var maanNimi = document.getElementById("maanNimi").value.trim();
    if (maanNimi === "") {
        alert("enter the name of the world!");
    } else {
        //alert("Liitytty maahan: " + maanNimi);
        document.getElementById("menu").style.display = "none";
        alustaMaailma();
        spawnUkkeli();
        canvas.style.display = "block";
        maahanLiittynyt = true;
    }
}

function alustaMaailma() {
    maailma = [];
    ilma = [];
    for (var i = 0; i < canvas.width; i += 20) {
        for (var j = 0; j < canvas.height; j += 20) {
            if (j < canvas.height * 0.4) { // 40% yläosasta ilmaa
                ilma.push({ x: i, y: j, leveys: 20, korkeus: 20 });
            } else {
                maailma.push({ x: i, y: j, leveys: 20, korkeus: 20 });
            }
        }
    }
}


function piirraMaailma() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ilma.forEach(function(palikka) {
        ctx.fillStyle = "lightblue";
        ctx.fillRect(palikka.x, palikka.y, palikka.leveys, palikka.korkeus);
    });
    maailma.forEach(function(palikka) {
        ctx.fillStyle = "brown";
        ctx.fillRect(palikka.x, palikka.y, palikka.leveys, palikka.korkeus);
        ctx.strokeStyle = "black";
        ctx.strokeRect(palikka.x, palikka.y, palikka.leveys, palikka.korkeus);
    });
}

function piirraUkkeli() {
    ctx.beginPath();
    ctx.arc(ukkeli.x, ukkeli.y, ukkeli.halkaisija, 0, Math.PI * 2);
    ctx.fillStyle = "peachpuff";
    ctx.fill();
    ctx.closePath();
}

function piirraTekstiLaatikko() {
}

function spawnUkkeli() {
    var randomIndex = Math.floor(Math.random() * maailma.length);
    var spawnPalikka = maailma[randomIndex];
    //ukkeli.x = spawnPalikka.x + spawnPalikka.leveys / 2; // Spawnaa palikan keskelle
    //ukkeli.y = spawnPalikka.y - ukkeli.halkaisija; // Asettaa ukkelin palikan päälle
    ukkeli.x = 300;
    ukkeli.y = 210;
    ukkeli.hyppy = false; // Nollataan hyppy
    ukkeli.hyppyNopeus = 10;
}

function liikutaUkkeli(suunta) {
    var uusiX = ukkeli.x;
    if (suunta === "left") {
        uusiX -= ukkeli.nopeus;
    } else if (suunta === "right") {
        uusiX += ukkeli.nopeus;
    }

    // Tarkistetaan, että ukkeli ei mene ruskeiden palikoiden läpi
    for (var i = 0; i < maailma.length; i++) {
        var palikka = maailma[i];
        if (ukkeli.y >= palikka.y && ukkeli.y <= palikka.y + palikka.korkeus) {
            if (uusiX - ukkeli.halkaisija >= palikka.x && uusiX + ukkeli.halkaisija <= palikka.x + palikka.leveys) {
                ukkeli.x = uusiX;
            }
        }
    }
}

function naytaKirjoituskentta() {
    var tekstiKentta = document.getElementById("tekstiKentta");
    tekstiKentta.style.display = "block";
    document.getElementById("puhekuplaTeksti").focus();
}

function piirraPuhekupla() {
    if (puhekupla.nakyvissa) {
        ctx.fillStyle = "white";
        ctx.fillRect(ukkeli.x - 20, ukkeli.y - 40, 100, 30);
        ctx.strokeStyle = "black";
        ctx.strokeRect(ukkeli.x - 20, ukkeli.y - 40, 100, 30);
        ctx.fillStyle = "black";
        ctx.fillText(puhekupla.teksti, ukkeli.x - 15, ukkeli.y - 20);
    }
}

function enterPainettu() {
    if (writingMessage) {
        puhekupla.teksti = document.getElementById("puhekuplaTeksti").value;
        puhekupla.nakyvissa = true;
        puhekupla.piilota = Date.now() + 3000;
        
        document.getElementById("puhekuplaTeksti").value = "";
        document.getElementById("tekstiKentta").style.display = "none";
        writingMessage = false;
    } else {
        writingMessage = true;
        naytaKirjoituskentta();
    }
}

function checkForeverLoop() {
    var currentTimeStamp = Date.now();

    if (currentTimeStamp >= puhekupla.piilota) {
        puhekupla.nakyvissa = false;
    }

    setTimeout(checkForeverLoop, 100);
}


window.addEventListener("keydown", function(event) {
    if (maahanLiittynyt) {
        if (writingMessage == false) {
            if (event.key === "a") {
                moveLeft = true;
            } else if (event.key === "d") {
                moveRight = true;
            } else if (event.key === "w" && !ukkeli.hyppy) {
                ukkeli.hyppy = true;
                ukkeli.hyppyNopeus = -10;
            }
        }

        if (event.key === "Enter") {
            enterPainettu();
        }
        if (event.key === "Escape") {
            document.getElementById("menu").style.display = "block";
            canvas.style.display = "none";
            maahanLiittynyt = false;
        }
    }
});

window.addEventListener("keyup", function(event) {
    if (event.key === "a") {
        moveLeft = false;
    }
    if (event.key === "d") {
        moveRight = false;
    }
});

function animateMovement() {
    var uusiX = ukkeli.x;
    var speed = 4;
    if (moveLeft) {
        uusiX -= speed;
    }
    if (moveRight) {
        uusiX += speed;
    }

    // Hyppylogiikka
    if (ukkeli.hyppy) {
        ukkeli.y += ukkeli.hyppyNopeus;
        ukkeli.hyppyNopeus += 0.5; // Gravitaatio
        var floorSurface = canvas.height - ukkeli.halkaisija - 360;
        if (ukkeli.y >= floorSurface) {
            ukkeli.y = floorSurface;
            ukkeli.hyppy = false;
        }
    }

    // Tarkistetaan, että ukkeli ei mene ruudun ulkopuolelle
    if (uusiX - ukkeli.halkaisija > 0 && uusiX + ukkeli.halkaisija < canvas.width) {
        ukkeli.x = uusiX;
    }

    // Tarkistetaan, että ukkeli ei mene ruskeiden palikoiden läpi putoamisen aikana
    if (ukkeli.hyppy && !maahanAlla()) {
        for (var i = 0; i < maailma.length; i++) {
            var palikka = maailma[i];
            if (ukkeli.y + ukkeli.halkaisija >= palikka.y && ukkeli.y + ukkeli.halkaisija <= palikka.y + palikka.korkeus) {
                if (ukkeli.x - ukkeli.halkaisija >= palikka.x && ukkeli.x + ukkeli.halkaisija <= palikka.x + palikka.leveys) {
                    ukkeli.y = palikka.y - ukkeli.halkaisija;
                    ukkeli.hyppy = false;
                }
            }
        }
    }
    
    piirraMaailma();
    piirraUkkeli();
    piirraPuhekupla();
    requestAnimationFrame(animateMovement);
}
requestAnimationFrame(animateMovement);

function maahanAlla() {
    for (var i = 0; i < maailma.length; i++) {
        var palikka = maailma[i];
        if (ukkeli.y + ukkeli.halkaisija >= palikka.y && ukkeli.y + ukkeli.halkaisija <= palikka.y + palikka.korkeus) {
            if (ukkeli.x - ukkeli.halkaisija >= palikka.x && ukkeli.x + ukkeli.halkaisija <= palikka.x + palikka.leveys) {
                return true;
            }
        }
    }
    return false;
}

// Lisää tapahtumankäsittelijä klikkauksille, jotta voit tuhota palikoita klikkaamalla niitä ja lisää portaalin ja valikon koodi
canvas.addEventListener("click", function(event) {
    var x = event.clientX - canvas.getBoundingClientRect().left;
    var y = event.clientY - canvas.getBoundingClientRect().top;
    for (var i = 0; i < maailma.length; i++) {
        var palikka = maailma[i];
        if (x >= palikka.x && x <= palikka.x + palikka.leveys && y >= palikka.y && y <= palikka.y + palikka.korkeus) {
            ilma.push(palikka);
            maailma.splice(i, 1);
            break;
        }
    }
    
    // Lisää portaali maailman yläreunaan
    if (y === 0) {
        maailma.push({ x: x, y: y, leveys: 20, korkeus: 20 });
    }
    
    // Lisää valikkonappi portaalin yläpuolelle
    if (ukkeli.y <= 0 && ukkeli.x >= x && ukkeli.x <= x + 20) {
        ctx.fillStyle = "orange";
        ctx.fillRect(x, y - 30, 20, 20);
        ctx.fillStyle = "white";
        ctx.fillText("Menu", x + 3, y - 15);
    }
    

});

document.addEventListener('DOMContentLoaded', function() {
    // Your code here
    console.log('DOM is ready');

    checkForeverLoop();

    liityMaa();


});
</script>
</body>
</html>
